<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã¯ã‚‹ã¡ã‚ƒã‚“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸ“…ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; font-size: 16px; }
    body {
      font-family: "Noto Sans JP","Yu Gothic UI","Yu Gothic","Meiryo","Segoe UI",system-ui,-apple-system,sans-serif;
      line-height: 1.5; letter-spacing: .02em; -webkit-font-smoothing: antialiased;
      background:#f8f6ff; margin:0; padding:20px;
    }
    h1 { font-size:22px; color:#4a3b8f; margin-bottom:16px; font-weight:700; }
    button, input, select, textarea { font: inherit; color: inherit; letter-spacing: inherit; line-height:1.4; }

    /* ğŸŸª å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šäºˆå®šä¸€è¦§â†’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼â†’ãƒ•ã‚©ãƒ¼ãƒ â†’ã‚¿ã‚¹ã‚¯ */
    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
      align-items: start;
    }

    /* âœ¨ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ  */
    .calendar {
      background:#fff;
      border-radius:16px;
      box-shadow:0 2px 6px rgba(0,0,0,.1);
      padding:16px;
      position:relative;
    }

    .cal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .cal-header button{
      border:none;
      background:#8b80ff;
      color:#fff;
      border-radius:999px;
      width:40px;
      height:32px;
      cursor:pointer;
    }

    .weekdays{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      text-align:center;
      color:#666;
      font-weight:bold;
      font-size:13px;
      margin-bottom:6px;
    }
    .days{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
    }
    .day{
      background:#f3f2ff;
      border-radius:12px;
      padding:6px;
      min-height:78px;
      display:flex;
      flex-direction:column;
      gap:2px;
      position:relative;
      cursor:pointer;
      transition:transform .1s;
    }
    .day:hover{ background:linear-gradient(180deg,#fefbff 0%,#f3edff 100%); transform:scale(1.03); }
    .day.other-month{ opacity:.3; }
    .day.saturday{ background:#e7f1ff; }
    .day.sunday{ background:#f0e5ff; }
    .day.holiday{ background:#ffe6ef; border-left:4px solid #ff7aa2; }

    .day-number{ font-weight:700; font-size:13px; }
    .day.today{
      box-shadow:0 0 0 2px #8a7dff inset, 0 0 0 4px rgba(138,125,255,.12) inset;
      background:linear-gradient(180deg,#f5f2ff 0%, #ece8ff 100%);
    }
    .day.selected{
      outline:2px dotted #8a7dff; outline-offset:2px; background:#f6f3ff;
    }

    .stamp-wrap{
      position:absolute; top:4px; right:6px;
      display:flex; flex-direction:column; gap:6px; align-items:flex-end;
      pointer-events:none;
    }
    .stamp{
      width:22px; height:22px;
      display:flex; align-items:center; justify-content:center;
      color:#fff; border-radius:50%;
      font-weight:700; font-size:10px; line-height:1;
      writing-mode:vertical-rl; padding:0; pointer-events:none;
    }
    .stamp--holiday{ background:rgba(255,122,162,.85); }
    .stamp--paid{ background:rgba(255,122,162,.60); }
    .stamp--cat{ background:rgba(77,171,247,.85); }
    .stamp--bd{ background:rgba(255,193,7,.85); }
    .stamp--anniv{ background:rgba(138,125,255,.85); }
    .stamp--more{ background:rgba(108,117,125,.85); }
    .stamp--trash{ background:rgba(0,0,0,.75); }

    .dot{ width:7px; height:7px; background:#ff7aa2; border-radius:50%; position:absolute; bottom:5px; right:5px; }

    /* ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆäºˆå®šä¸€è¦§ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ãƒ»ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆï¼‰ */
    .side{
      background:#fff; border-radius:16px; padding:16px;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
      display:grid; gap:16px;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ ãªã©å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    form{ background:#f9f8ff; border-radius:12px; padding:12px; margin:0; }
    label{ display:block; font-size:13px; margin-bottom:4px; color:#333; }
    input, textarea{
      width:100%; border:1px solid #ccc; border-radius:8px;
      padding:6px; font-size:14px; margin-bottom:10px;
    }
    button.add{
      background:#8b80ff; border:none; color:#fff; border-radius:8px;
      padding:8px 12px; font-size:14px; cursor:pointer;
    }

    /* äºˆå®šä¸€è¦§ã‚«ãƒ¼ãƒ‰ */
    .event-list{ margin-top:0; }
    .event{
      background:#f4f2ff; border-radius:10px;
      margin-bottom:8px; padding:8px;
      display:flex; justify-content:space-between;
      gap:6px; align-items:flex-start;
    }
    .event button.edit{
      background:#a3a3aa; color:#fff; border:none;
      border-radius:6px; padding:3px 10px; font-size:12px;
      cursor:pointer;
    }

    /* ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ */
    .tasks{
      background:#fff; border-radius:16px; padding:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    .task-head{ display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .task-input-row{ display:grid; grid-template-columns:1fr auto; gap:8px; }
    .task-filters{ display:flex; gap:8px; margin:10px 0; flex-wrap:wrap; }
    .chip{
      border:1px solid #cfc9ff; background:#f4f2ff;
      padding:4px 10px; border-radius:999px;
      font-size:12px; cursor:pointer;
    }
    .chip.active{ background:#8b80ff; color:#fff; border-color:#8b80ff; }

    .task-item{
      display:grid; grid-template-columns:auto 1fr auto;
      align-items:center; gap:8px;
      background:#f9f8ff; border-radius:10px;
      padding:8px;
    }
    .btn-danger{ background:#ff6b6b; color:#fff; }
    .btn-ghost{ background:#ebe7ff; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãªã©ã¯Part3ã§JSã¨ä¸€ç·’ã« */
  </style>
</head>
<body>
  <h1>ã¯ã‚‹ã¡ã‚ƒã‚“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ğŸ“…</h1>

  <div class="layout">

    <!-- ğŸ“â‘  ä»Šæ—¥ã®äºˆå®šä¸€è¦§ï¼ˆæœ€åˆã«è¡¨ç¤ºï¼‰ -->
    <div class="side" id="event-section">
      <div class="event-list">
        <h3 id="selected-date-label">ä»Šæ—¥ã®äºˆå®š</h3>
        <div id="event-list-body"></div>
      </div>
    </div>

    <!-- ğŸ“…â‘¡ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div class="calendar">
      <div class="cal-header">
        <button id="prev-month" aria-label="å‰ã®æœˆ">â†</button>
        <div style="display:flex;align-items:center;gap:8px;">
          <div id="current-month"></div>
        </div>
        <button id="next-month" aria-label="æ¬¡ã®æœˆ">â†’</button>
      </div>

      <button id="open-cal-manager" title="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è‡ªå‹•ãƒãƒ¼ã‚¯è¨­å®š">âš™ï¸</button>

      <div class="weekdays"><div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div></div>
      <div id="days" class="days"></div>
    </div>

    <!-- âœï¸â‘¢ äºˆå®šã‚’è¿½åŠ ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="side">
      <form id="event-form">
        <label>æ—¥ã«ã¡</label><input type="date" id="date" required />
        <label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" id="title" placeholder="ãƒã‚¤ãƒ«ãƒ»ç—…é™¢ãƒ»çŒ«ã”ã¯ã‚“ãªã©" required />
        <label>ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚ŠOKï¼‰</label>
        <input list="tag-options" id="tags" placeholder="#å¹´ä¼‘ #ç¾å®¹ #çŒ«" /><datalist id="tag-options"></datalist>

        <div style="margin-top:6px; display:flex;">
          <button type="button" id="open-tag-manager" class="tag-manage-btn icon" title="ã‚¿ã‚°ç®¡ç†" aria-label="ã‚¿ã‚°ç®¡ç†">ğŸ·ï¸</button>
        </div>

        <div id="tag-manager" class="tag-manager">
          <div class="tag-manager-card">
            <div class="tag-manager-head">
              <strong>ã‚¿ã‚°å€™è£œã®ç®¡ç†</strong>
              <div class="spacer"></div>
              <button type="button" id="close-tag-manager" class="tag-close-btn">âœ–</button>
            </div>
            <p style="margin:6px 0 10px;">å€™è£œã‹ã‚‰æ¶ˆã—ãŸã„ã‚¿ã‚°ã‚’å‰Šé™¤ã§ãã¾ã™ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆæœ¬æ–‡ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼‰</p>
            <div id="tag-chip-list" class="tag-chip-list"></div>
            <div class="tag-actions">
              <button type="button" id="purge-unused-tags" class="tag-secondary">æœªä½¿ç”¨ã‚¿ã‚°ã‚’ä¸€æ‹¬å‰Šé™¤</button>
              <button type="button" id="clear-all-tags" class="tag-danger">å…¨éƒ¨æ¶ˆã™</button>
            </div>
          </div>
        </div>

        <label>ãƒ¡ãƒ¢</label><textarea id="memo" rows="2"></textarea>
        <button type="submit" class="add" id="submit-btn">ğŸ“Œ äºˆå®šã‚’è¿½åŠ </button>
        <div class="edit-actions" id="edit-actions">
          <button type="button" id="delete-current">ã“ã®äºˆå®šã‚’å‰Šé™¤</button>
          <button type="button" id="cancel-edit">ç·¨é›†ã‚’ã‚„ã‚ã‚‹</button>
        </div>
      </form>
    </div>

    <!-- ğŸ§¾â‘£ ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆï¼ˆæœ€å¾Œï¼‰ -->
    <div class="side">
      <section class="tasks" aria-label="ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ">
        <div class="task-head">
          <h3 style="margin:0;">ğŸ§¾ ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ</h3><small id="task-count">0 ä»¶</small>
        </div>
        <div class="task-input-row">
          <input type="text" id="task-input" placeholder="ä¾‹ï¼šå¯å®¤ãƒŸãƒŸã‚¹ãƒšãƒ¼ã‚¹ç¢ºä¿ / ãƒ¡ãƒ«ã‚«ãƒªå‡ºå“ ãªã©" />
          <button type="button" id="task-add">ï¼‹ è¿½åŠ </button>
        </div>
        <div class="task-filters">
          <button type="button" class="chip active" data-filter="all">ã™ã¹ã¦</button>
          <button type="button" class="chip" data-filter="todo">æœªå®Œäº†</button>
          <button type="button" class="chip" data-filter="done">å®Œäº†</button>
        </div>
        <div id="task-list" class="task-list"></div>
        <div class="task-footer">
          <small>Enterã§è¿½åŠ  / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†å¯</small>
          <div class="task-actions">
            <button type="button" class="btn-ghost" id="export-tasks">æ›¸ãå‡ºã—</button>
            <button type="button" class="btn-danger" id="clear-done">å®Œäº†ã‚’ä¸€æ‹¬å‰Šé™¤</button>
          </div>
        </div>
      </section>
    </div>

  </div> <!-- /.layout -->
  <!-- JSã“ã“ã‹ã‚‰ -->
  <script>
    /* ====== Keys & Storage ====== */
    const CUSTOM_SPECIAL_KEY = 'haru-custom-special';
    const CUSTOM_HOLIDAY_KEY = 'haru-custom-holiday-dates';
    const RECURRING_KEY = 'haru-recurring';
    function loadCustomSpecial(){ return JSON.parse(localStorage.getItem(CUSTOM_SPECIAL_KEY) || '{}'); }
    function saveCustomSpecial(obj){ localStorage.setItem(CUSTOM_SPECIAL_KEY, JSON.stringify(obj)); }
    function loadCustomHolidayDates(){ return new Set(JSON.parse(localStorage.getItem(CUSTOM_HOLIDAY_KEY) || '[]')); }
    function saveCustomHolidayDates(set){ localStorage.setItem(CUSTOM_HOLIDAY_KEY, JSON.stringify([...set])); }
    function loadRecurring(){ return JSON.parse(localStorage.getItem(RECURRING_KEY) || '[]'); }
    function saveRecurring(list){ localStorage.setItem(RECURRING_KEY, JSON.stringify(list)); }

    /* ====== Built-in special days ====== */
    const specialDays = {
      "2025-01-01": ["å…ƒæ—¥ğŸ"], "2025-01-13": ["æˆäººã®æ—¥ğŸ‰"], "2025-02-11": ["å»ºå›½è¨˜å¿µã®æ—¥ğŸ‡¯ğŸ‡µ"],
      "2025-02-22": ["çŒ«ã®æ—¥ğŸ±"], "2025-02-23": ["å¤©çš‡èª•ç”Ÿæ—¥ğŸ‚"], "2025-02-24": ["ä¼‘æ—¥ğŸŒ"],
      "2025-03-20": ["æ˜¥åˆ†ã®æ—¥ğŸŒ¸"], "2025-04-29": ["æ˜­å’Œã®æ—¥"], "2025-05-03": ["æ†²æ³•è¨˜å¿µæ—¥ğŸ“œ"],
      "2025-05-04": ["ã¿ã©ã‚Šã®æ—¥ğŸŒ¿"], "2025-05-05": ["ã“ã©ã‚‚ã®æ—¥ğŸ"], "2025-05-06": ["ä¼‘æ—¥ğŸŒ"],
      "2025-07-21": ["æµ·ã®æ—¥ğŸŒŠ"], "2025-08-11": ["å±±ã®æ—¥â›°ï¸"], "2025-09-15": ["æ•¬è€ã®æ—¥ğŸ‘µğŸ‘´"],
      "2025-09-23": ["ç§‹åˆ†ã®æ—¥ğŸ"], "2025-10-13": ["ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥ğŸƒ"], "2025-11-03": ["æ–‡åŒ–ã®æ—¥âœ¨"],
      "2025-11-23": ["å‹¤åŠ´æ„Ÿè¬ã®æ—¥ğŸ™"], "2025-11-24": ["ä¼‘æ—¥ğŸŒ"]
    };
    const yearlySpecialDays = {
      "-01-13": ["è¨˜å¿µæ—¥ğŸ’—ï¼ˆ2012&2017ï¼‰"],
      "-09-22": ["ã¯ã‚‹ã¡ã‚ƒã‚“BDğŸ‚"],
      "-12-23": ["ã‘ã‚“ã¡ã‚ƒã‚“BDğŸ‚"]
    };

    /* ====== Events storage ====== */
    let events = JSON.parse(localStorage.getItem("haru-events") || "[]");
    let editingId = null;
    const now = new Date();
    const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;
    let current = new Date();
    let selectedDate = todayStr;

    /* ====== Element refs ====== */
    const daysEl = document.getElementById("days");
    const monthLabel = document.getElementById("current-month");
    const eventListBody = document.getElementById("event-list-body");
    const selectedDateLabel = document.getElementById("selected-date-label");
    const dateInput = document.getElementById("date");
    const titleInput = document.getElementById("title");
    const tagsInput = document.getElementById("tags");
    const memoInput = document.getElementById("memo");
    const submitBtn = document.getElementById("submit-btn");
    const editActions = document.getElementById("edit-actions");
    const deleteCurrentBtn = document.getElementById("delete-current");
    const cancelEditBtn = document.getElementById("cancel-edit");
    /* ====== Utility: special labels tooltip ====== */
    function getSpecialLabels(dateStr){
      const labels = [];
      if (specialDays[dateStr]) labels.push(...specialDays[dateStr]);
      const md = dateStr.slice(4);
      if (yearlySpecialDays[md]) labels.push(...yearlySpecialDays[md]);
      const custom = loadCustomSpecial();
      if (custom[dateStr]) labels.push(...custom[dateStr]);
      return labels;
    }

    /* ====== Recurring helper ====== */
    function getNthWeekdayOfMonth(date){
      const d = date.getDate();
      return Math.floor((d - 1) / 7) + 1; // 1ã€œ5
    }

    /* ====== Top-right stamps ====== */
    function getTopRightStamp(dateStr){
      const dayEvents = events.filter(e => e.date === dateStr);
      const stampRules = [
        { re: /(å¹´ä¼‘|æœ‰ä¼‘)/, text: "å¹´ä¼‘" },
        { re: /(ä»£ä¼‘|æŒ¯ä¼‘)/, text: "ä»£ä¼‘" },
      ];
      for (const ev of dayEvents){
        const hay = `${ev.title || ""} ${ev.tags || ""}`;
        for (const rule of stampRules){
          if (rule.re.test(hay)) return rule;
        }
      }
      return null;
    }

    function buildStampList(dateStr){
      const stamps = [];

      // ç¥æ—¥ã‚¹ã‚¿ãƒ³ãƒ—
      const holidayLabels = specialDays[dateStr] ? [...specialDays[dateStr]] : [];
      if (holidayLabels.length){
        stamps.push({
          key:"holiday",
          text:"ç¥",
          info:holidayLabels.join(" / "),
          className:"stamp--holiday"
        });
      }

      // æ¯å¹´ã®è¨˜å¿µæ—¥ãªã©
      const md = dateStr.slice(4);
      const yearly = yearlySpecialDays[md] ? [...yearlySpecialDays[md]] : [];
      yearly.forEach(lbl => {
        if (lbl.includes("çŒ«ã®æ—¥")) stamps.push({ key:"cat", text:"çŒ«", info:lbl, className:"stamp--cat" });
        else if (lbl.includes("BD") || lbl.includes("èª•")) stamps.push({ key:"bd", text:"BD", info:lbl, className:"stamp--bd" });
        else stamps.push({ key:"anniv", text:"è¨˜", info:lbl, className:"stamp--anniv" });
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰åˆ¤å®šã™ã‚‹å¹´ä¼‘ãƒ»ä»£ä¼‘ãƒ•ãƒ©ã‚°
      const userRule = getTopRightStamp(dateStr);
      if (userRule){
        stamps.push({
          key:"paid",
          text:userRule.text,
          info:userRule.text,
          className:"stamp--paid"
        });
      }

      // ğŸ” ç¹°ã‚Šè¿”ã—è¨­å®šï¼ˆæ¯é€± / ç¬¬nâ—¯æ›œï¼‰
      const recList = loadRecurring();
      const dObj = new Date(dateStr);
      const wd = dObj.getDay();
      const nth = getNthWeekdayOfMonth(dObj);
      recList.forEach(r => {
        if (r.type === 'weekly' && r.weekday === wd){
          stamps.push({
            key:r.key || 'rec',
            text:r.text.slice(0,2),
            info:r.text,
            className:r.className || 'stamp--anniv'
          });
        }
        if (r.type === 'nthWeekday' && r.weekday === wd && r.nth === nth){
          stamps.push({
            key:r.key || 'rec-nth',
            text:r.text.slice(0,2),
            info:`${r.text}ï¼ˆç¬¬${r.nth}ï¼‰`,
            className:r.className || 'stamp--anniv'
          });
        }
      });

      // å¤šã™ãã‚‹ã¨ãã¯ã€Œ+â—¯ã€ã«ã¾ã¨ã‚ã‚‹
      const MAX = 3;
      if (stamps.length > MAX){
        const hidden = stamps.length - (MAX - 1);
        const head = stamps.slice(0, MAX - 1);
        head.push({
          key:"more",
          text:`+${hidden}`,
          info: stamps.slice(MAX-1).map(s=>s.info).join(" / "),
          className:"stamp--more"
        });
        return head;
      }
      return stamps;
    }

    /* ====== Calendar render ====== */
    function renderCalendar(){
      const year = current.getFullYear();
      const month = current.getMonth();
      const firstDay = new Date(year, month, 1);
      const startDay = firstDay.getDay();
      const lastDate = new Date(year, month+1, 0).getDate();
      const prevLastDate = new Date(year, month, 0).getDate();

      monthLabel.textContent = `${year}å¹´${month+1}æœˆ`;
      daysEl.innerHTML = "";

      // å‰æœˆã®ä½™ç™½
      for (let i = startDay - 1; i >= 0; i--){
        const d = document.createElement("div");
        d.className = "day other-month";
        d.innerHTML = `<div class="day-number">${prevLastDate - i}</div>`;
        daysEl.appendChild(d);
      }

      // å½“æœˆ
      for (let d = 1; d <= lastDate; d++){
        const dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
        const div = document.createElement("div");
        div.className = "day";
        if (dateStr === todayStr) div.classList.add("today");

        const dateObj = new Date(year, month, d);
        const dow = dateObj.getDay();
        if (dow === 0) div.classList.add("sunday");
        if (dow === 6) div.classList.add("saturday");

        const customHolidayDates = loadCustomHolidayDates();
        if (specialDays[dateStr] || customHolidayDates.has(dateStr)) div.classList.add("holiday");

        const tipLabels = getSpecialLabels(dateStr);
        if (tipLabels.length){
          const tip = tipLabels.join(" / ");
          div.title = tip;
          div.setAttribute("aria-label", tip);
        }
        if (dateStr === selectedDate) div.classList.add("selected");

        const hasEvent = events.some(e => e.date === dateStr);
        let html = `<div class="day-number">${d}</div>`;

        const stamps = buildStampList(dateStr);
        if (stamps.length){
          html += `<div class="stamp-wrap">` +
            stamps.map(s => `<span class="stamp ${s.className}" data-info="${s.info}" title="${s.info}">${s.text}</span>`).join("") +
            `</div>`;
        }
        if (hasEvent) html += `<div class="dot"></div>`;
        div.innerHTML = html;

        // ã‚¯ãƒªãƒƒã‚¯ã§æ—¥ä»˜é¸æŠ
        div.addEventListener("click", () => {
          selectedDate = dateStr;
          dateInput.value = dateStr;
          cancelEdit();
          titleInput.value = "";
          tagsInput.value = "";
          memoInput.value = "";
          renderCalendar();
          renderDayEvents();
        });

        // å³ã‚¯ãƒªãƒƒã‚¯ / é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼
        attachDayMenuHandlers(div, dateStr);

        daysEl.appendChild(div);
      }

      // å¾Œã‚ã®ä½™ç™½ï¼ˆ42ãƒã‚¹ã«æƒãˆã‚‹ï¼‰
      const total = daysEl.children.length;
      for (let i = total; i < 42; i++){
        const d = document.createElement("div");
        d.className = "day other-month";
        d.innerHTML = `<div class="day-number"></div>`;
        daysEl.appendChild(d);
      }
    }

    /* ====== Day events list ====== */
    function renderDayEvents(){
      selectedDateLabel.textContent = `${selectedDate} ã®äºˆå®š`;
      const dayEvents = events.filter(e => e.date === selectedDate);
      const autoLabels = getSpecialLabels(selectedDate);
      eventListBody.innerHTML = "";

      // è‡ªå‹•ãƒ©ãƒ™ãƒ«ï¼ˆç¥æ—¥ã‚„è¨˜å¿µæ—¥ï¼‰
      if (autoLabels.length > 0){
        autoLabels.forEach(lbl => {
          const div = document.createElement("div");
          div.className = "event";
          div.innerHTML = `<div><strong>${lbl}</strong></div>`;
          eventListBody.appendChild(div);
        });
      }

      if (dayEvents.length === 0 && autoLabels.length === 0){
        eventListBody.innerHTML = "<p>äºˆå®šãªã—ğŸ˜Š</p>";
        return;
      }

      // é€šå¸¸ã®äºˆå®š
      dayEvents.forEach(e => {
        const div = document.createElement("div");
        div.className = "event";
        const tagDisplay = e.tags
          ? e.tags.split(/\s+/).filter(Boolean).map(t => `<span>${t}</span>`).join(" ")
          : "";
        const left = document.createElement("div");
        left.innerHTML =
          `<strong>${e.title}</strong>` +
          (tagDisplay ? `<small>ğŸ·ï¸ ${tagDisplay}</small>` : "") +
          (e.memo ? `<small>ğŸ“ ${e.memo}</small>` : "");
        const editBtn = document.createElement("button");
        editBtn.textContent = "ç·¨é›†";
        editBtn.className = "edit";
        editBtn.addEventListener("click", () => { startEdit(e); });
        div.appendChild(left);
        div.appendChild(editBtn);
        eventListBody.appendChild(div);
      });
    }

    /* ====== Edit helpers ====== */
    function startEdit(evObj){
      editingId = evObj.id;
      dateInput.value = evObj.date;
      titleInput.value = evObj.title;
      tagsInput.value = evObj.tags || "";
      memoInput.value = evObj.memo || "";
      submitBtn.textContent = "âœï¸ äºˆå®šã‚’æ›´æ–°";
      submitBtn.classList.add("editing");
      editActions.style.display = "flex";
    }
    function cancelEdit(){
      editingId = null;
      submitBtn.textContent = "ğŸ“Œ äºˆå®šã‚’è¿½åŠ ";
      submitBtn.classList.remove("editing");
      editActions.style.display = "none";
    }

    /* ====== Event form submit ====== */
    document.getElementById("event-form").addEventListener("submit", (ev) => {
      ev.preventDefault();
      const date = dateInput.value;
      const title = titleInput.value;
      const tags = (tagsInput.value || "").trim();
      const memo = memoInput.value;

      if (editingId){
        const idx = events.findIndex(x => x.id === editingId);
        if (idx !== -1){
          events[idx].date = date;
          events[idx].title = title;
          events[idx].tags = tags;
          events[idx].memo = memo;
        }
      } else {
        events.push({
          id: "evt_" + Date.now() + "_" + Math.random().toString(16).slice(2),
          date, title, tags, memo
        });
      }
      localStorage.setItem("haru-events", JSON.stringify(events));
      selectedDate = date;
      resetFormKeepDate();
      cancelEdit();
      renderCalendar();
      renderDayEvents();
      updateTagSuggestions();
    });

    deleteCurrentBtn.addEventListener("click", () => {
      if (!editingId) return;
      events = events.filter(ev => ev.id !== editingId);
      localStorage.setItem("haru-events", JSON.stringify(events));
      cancelEdit();
      renderCalendar();
      renderDayEvents();
      updateTagSuggestions();
    });
    cancelEditBtn.addEventListener("click", () => { cancelEdit(); });

    /* ====== Month navigation ====== */
    document.getElementById("prev-month").onclick = () => {
      current.setMonth(current.getMonth() - 1);
      cancelEdit();
      renderCalendar();
      renderDayEvents();
    };
    document.getElementById("next-month").onclick = () => {
      current.setMonth(current.getMonth() + 1);
      cancelEdit();
      renderCalendar();
      renderDayEvents();
    };

    /* ====== Stamp click tooltip ====== */
    daysEl.addEventListener("click", (e) => {
      const t = e.target;
      if (t.classList && t.classList.contains("stamp")){
        e.stopPropagation();
        alert(t.dataset.info || t.textContent);
      }
    });

    /* ====== Tag suggestions ====== */
    function updateTagSuggestions(){
      const tagSet = new Set(JSON.parse(localStorage.getItem("haru-tags") || "[]"));
      events.forEach(e => {
        if (e.tags) e.tags.split(/\s+/).forEach(tag => {
          const t = tag.trim();
          if (t) tagSet.add(t);
        });
      });
      localStorage.setItem("haru-tags", JSON.stringify([...tagSet]));
      const datalist = document.getElementById("tag-options");
      datalist.innerHTML = "";
      [...tagSet].forEach(tag => {
        if (tag){
          const option = document.createElement("option");
          option.value = tag;
          datalist.appendChild(option);
        }
      });
    }
    function getTagSet(){ return new Set(JSON.parse(localStorage.getItem("haru-tags") || "[]")); }
    function saveTagSet(tagSet){
      localStorage.setItem("haru-tags", JSON.stringify([...tagSet]));
      updateTagSuggestions();
    }
    function renderTagManager(){
      const wrap = document.getElementById("tag-chip-list");
      wrap.innerHTML = "";
      const tagSet = getTagSet();
      if (tagSet.size === 0){
        wrap.innerHTML = '<p style="margin:6px 0;">ï¼ˆå€™è£œã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</p>';
        return;
      }
      [...tagSet].forEach(tag => {
        const chip = document.createElement("span");
        chip.className = "tag-chip";
        chip.innerHTML = `<span>${tag}</span>`;
        const del = document.createElement("button");
        del.textContent = "å‰Šé™¤";
        del.title = `å€™è£œã‹ã‚‰ ${tag} ã‚’å‰Šé™¤`;
        del.onclick = () => {
          const s = getTagSet();
          s.delete(tag);
          saveTagSet(s);
          renderTagManager();
        };
        chip.appendChild(del);
        wrap.appendChild(chip);
      });
    }

    document.getElementById("open-tag-manager").onclick = () => {
      document.getElementById("tag-manager").style.display = "flex";
      renderTagManager();
    };
    document.getElementById("close-tag-manager").onclick = () => {
      document.getElementById("tag-manager").style.display = "none";
    };
    document.getElementById("purge-unused-tags").onclick = () => {
      const used = new Set();
      events.forEach(e => {
        if (e.tags) e.tags.split(/\s+/).forEach(t => used.add(t.trim()));
      });
      const s = getTagSet();
      [...s].forEach(t => { if (!used.has(t)) s.delete(t); });
      saveTagSet(s);
      renderTagManager();
    };
    document.getElementById("clear-all-tags").onclick = () => {
      if (!confirm("ä¿å­˜æ¸ˆã¿ã®ã‚¿ã‚°å€™è£œã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      saveTagSet(new Set());
      renderTagManager();
    };

    function resetFormKeepDate(){
      const keepDate = dateInput.value;
      document.getElementById("event-form").reset();
      dateInput.value = keepDate;
    }

    /* ====== Context menu (right click / long press) ====== */
    const dayMenu = document.getElementById('day-menu');
    let dayMenuTargetDate = null;

    function openDayMenu(x,y,dateStr){
      dayMenuTargetDate = dateStr;
      dayMenu.style.left = x+'px';
      dayMenu.style.top = y+'px';
      dayMenu.style.display = 'block';
      dayMenu.setAttribute('aria-hidden','false');
    }
    function closeDayMenu(){
      dayMenu.style.display='none';
      dayMenu.setAttribute('aria-hidden','true');
      dayMenuTargetDate = null;
    }
    document.addEventListener('click',(e)=>{
      if (!dayMenu.contains(e.target)) closeDayMenu();
    });

    dayMenu.addEventListener('click',(e)=>{
      const act = e.target?.dataset?.act;
      if (!act || !dayMenuTargetDate) return;

      if (act === 'toggle-holiday'){
        const set = loadCustomHolidayDates();
        if (set.has(dayMenuTargetDate)) set.delete(dayMenuTargetDate);
        else set.add(dayMenuTargetDate);
        saveCustomHolidayDates(set);
      }
      if (act === 'add-label'){
        const label = prompt('ã“ã®æ—¥ã«è¿½åŠ ã™ã‚‹ãƒ©ãƒ™ãƒ«ï¼ˆä¾‹ï¼šæŒ¯æ›¿ä¼‘æ—¥ / å®¶æ—è¨˜å¿µæ—¥ï¼‰');
        if (label && label.trim()){
          const map = loadCustomSpecial();
          map[dayMenuTargetDate] = map[dayMenuTargetDate] || [];
          map[dayMenuTargetDate].push(label.trim());
          saveCustomSpecial(map);
        }
      }
      if (act === 'toggle-nenkyu'){
        togglePaidStamp(dayMenuTargetDate,'å¹´ä¼‘');
      }
      if (act === 'toggle-daikyu'){
        togglePaidStamp(dayMenuTargetDate,'ä»£ä¼‘');
      }

      renderCalendar();
      renderDayEvents();
      closeDayMenu();
    });

    function attachDayMenuHandlers(div, dateStr){
      // PCå³ã‚¯ãƒªãƒƒã‚¯
      div.addEventListener('contextmenu',(e)=>{
        e.preventDefault();
        openDayMenu(e.clientX, e.clientY, dateStr);
      });
      // ãƒ¢ãƒã‚¤ãƒ«é•·æŠ¼ã—
      let pressTimer=null;
      div.addEventListener('touchstart',(e)=>{
        pressTimer=setTimeout(()=>{
          const t=e.touches[0];
          openDayMenu(t.clientX, t.clientY, dateStr);
        },420);
      });
      ['touchend','touchmove','touchcancel'].forEach(ev=>{
        div.addEventListener(ev, ()=> clearTimeout(pressTimer));
      });
    }

    function togglePaidStamp(dateStr, kind){
      const flagTitle = `${kind}ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ï¼‰`;
      const idx = events.findIndex(e => e.date === dateStr && e.title === flagTitle);
      if (idx > -1){
        events.splice(idx,1);
      } else {
        events.push({ id:"evt_flag_"+Date.now(), date:dateStr, title:flagTitle, tags:"", memo:"" });
      }
      localStorage.setItem("haru-events", JSON.stringify(events));
    }

